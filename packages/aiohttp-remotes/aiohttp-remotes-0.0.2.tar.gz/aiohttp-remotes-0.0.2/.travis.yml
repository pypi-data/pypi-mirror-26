language: python
sudo: false

python:
  - 3.5
  - &mainstream_python 3.6

env:
  global:
    - FLIT_USERNAME=andrew.svetlov
    - secure: "ToILhFXCyk9jCpCCDT9FPLmKU5lXtQ9IfcPTNYmjgvanSGGwedilajeNvHr3jnz3rwNjpsPEwnBzg1kqtNiMpwSkhersZYUcH7ojLDb7JKlRXFJgxumeKef60JzRukiWh/hTJTFuybfEAOVF/HywaVe6r2pe8NoNZKo8mpjnFA6irB/qEXDbmo8sFt9ybZvJYJ0Ck06I64RRnrIVxUmRAk5qoBgPhJifYOtjh49M863aB7N2az5U0v31pdV/v9VLkIMEkwA7NTskXzQ5fAqr91DUm8eKbe9GPyzNnJG9eq9z42oXr9tw1WrAGrPPgpyt9Y+kmPM/qtT8YELPwAoHXs0yKxHRXhpvWZbXZ8jnR7JmCdvKJalJOelSjtA/aiadtXjgzyaY7s/A+ApcS6ItyCz5AmEnSZfcSn9JcX5D51N6Ldm1mmJ5W6a0EmGpg4CJ1kQzMqUcTcEBaubJRWC8FOtxWWWbeZkiZ6b7W5vpHGSQTRw+JXGDjRWnj8g78wPfDqqnB8qh67VMjWI4hFeT+R/kZi8DJIcxUFRf5WnFfj4hckIzGiLYqI1I0CRHU+/9y2NdC7sbQPFpQkYctMF4vy9qxifWLCGDrHLMq6rIQilB72Jl0Jb/29sM17WwB7go9Uz14GFxADBB3Kdk8sABK8mcCjRxF2TYrPlnvoEycek="


install:
  - travis_retry pip install codecov
  - travis_retry pip install -r requirements/ci.txt
  - flit install --symlink
script:
  - make test
  - codecov

_helpers:
- &_mainstream_python_base
  python: *mainstream_python
- &_reset_steps
  env: []
  before_install: skip
  install: skip
  script: skip
  after_success: []

jobs:
  include:
  - stage: lint
    <<: *_mainstream_python_base
    <<: *_reset_steps
    install:
      - travis_retry pip install -r requirements/lint.txt
      - flit install --symlink
    script:
      - make flake
  - stage: deploy
    if: tag IS present
    <<: *_mainstream_python_base
    <<: *_reset_steps
    install:
      - travis_retry pip install -r requirements/ci.txt
    script:
      - flit publish

stages:
  - name: lint
  - name: test
  - name: deploy
    # This will prevent deploy unless it's a tagged commit:
    if: tag IS present

cache: pip
before_cache:
- rm -f $HOME/.cache/pip/log/debug.log
