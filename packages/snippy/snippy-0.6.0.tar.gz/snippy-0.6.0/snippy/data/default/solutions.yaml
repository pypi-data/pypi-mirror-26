content:
- brief: Testing docker log drivers
  category: solution
  data:
  - '################################################################################'
  - '## BRIEF : Testing docker log drivers'
  - '##'
  - '## DATE  : 2017-10-30 08:17:10'
  - '## GROUP : docker'
  - '## TAGS  : docker,moby,kubernetes,logging,plugin,driver,kafka,logs2kafka'
  - '## FILE  : kubernetes-docker-log-driver-kafka.txt'
  - '################################################################################'
  - ''
  - '################################################################################'
  - '## description'
  - '################################################################################'
  - ''
  - '    # Investigating docker log driver and especially the Kafka plugin.'
  - ''
  - '################################################################################'
  - '## references'
  - '################################################################################'
  - ''
  - '    # Kube Kafka log driver'
  - '    > https://github.com/MickayG/moby-kafka-logdriver'
  - ''
  - '    # Logs2Kafka'
  - '    > https://groups.google.com/forum/#!topic/kubernetes-users/iLDsG85exRQ'
  - '    > https://github.com/garo/logs2kafka'
  - ''
  - '################################################################################'
  - '## commands'
  - '################################################################################'
  - ''
  - '    # Get logs from pods'
  - '    $ kubectl get pods'
  - '    $ kubectl logs kafka-0'
  - ''
  - '    # Install docker log driver for Kafka'
  - '    $ docker ps --format "{{.Names}}" | grep -E ''kafka|logstash'''
  - '    $ docker inspect k8s_POD_kafka-0...'
  - '    $ docker inspect --format ''{{ .NetworkSettings.IPAddress }}'' k8s_POD_kafka-0...'
  - '    $ docker plugin install --disable mickyg/kafka-logdriver:latest'
  - '    $ docker plugin set mickyg/kafka-logdriver:latest KAFKA_BROKER_ADDR="10.2.28.10:9092"'
  - '    $ docker plugin inspect mickyg/kafka-logdriver'
  - '    $ docker plugin enable mickyg/kafka-logdriver:latest'
  - '    $ docker run --log-driver mickyg/kafka-logdriver:latest hello-world'
  - '    $ docker plugin disable mickyg/kafka-logdriver:latest'
  - ''
  - '    # Get current docker log driver'
  - '    $ docker info |grep ''Logging Driver'' # Default driver'
  - '    $ docker ps --format "{{.Names}}" | grep -E ''kafka|logstash'''
  - '    $ docker inspect k8s_POD_kafka-0...'
  - '    $ docker inspect --format ''{{ .NetworkSettings.IPAddress }}'' k8s_POD_logstash...'
  - '    $ docker inspect --format ''{{ .NetworkSettings.IPAddress }}'' k8s_POD_kafka-0...'
  - '    $ docker inspect $(docker ps | grep POD | awk ''{print $1}'') | grep -E "Hostname|NetworkID'
  - '    $ docker inspect $(docker ps | grep POD | awk ''{print $1}'') | while read
    line ; do egrep -E ''"Hostname"|"IPAddress"'' ; done | while read line ; do echo
    $line ; done'
  - ''
  - '################################################################################'
  - '## solutions'
  - '################################################################################'
  - ''
  - '################################################################################'
  - '## configurations'
  - '################################################################################'
  - ''
  - '    # Logstash configuration'
  - '    $ vi elk-stack/logstash/build/pipeline/kafka.conf'
  - '      input {'
  - '          gelf {}'
  - '      }'
  - ''
  - '      output {'
  - '          elasticsearch {'
  - '            hosts => ["elasticsearch"]'
  - '          }'
  - '          stdout {}'
  - '      }'
  - ''
  - '    # Kafka configuration'
  - '    $ vi elk-stack/logstash/build/pipeline/kafka.conf'
  - '    kafka {'
  - '        type => "argus.docker"'
  - '        topics => ["dockerlogs"]'
  - '        codec => "plain"'
  - '        bootstrap_servers => "kafka:9092"'
  - '        consumer_threads => 1'
  - '    }'
  - ''
  - '################################################################################'
  - '## whiteboard'
  - '################################################################################'
  - ''
  digest: ce6ef2f0408ff3780dc4f34b93d281cd2a3c6b8d36ebfb8929b1d86f803e98b8
  filename: kubernetes-docker-log-driver-kafka.txt
  group: docker
  links:
  - https://github.com/MickayG/moby-kafka-logdriver
  - https://github.com/garo/logs2kafka
  - https://groups.google.com/forum/#!topic/kubernetes-users/iLDsG85exRQ
  tags:
  - docker
  - driver
  - kafka
  - kubernetes
  - logging
  - logs2kafka
  - moby
  - plugin
  utc: '2017-10-30 08:24:28'
- brief: Debugging nginx
  category: solution
  data:
  - '################################################################################'
  - '## BRIEF : Debugging nginx '
  - '##'
  - '## DATE  : 2017-10-20 06:16:27'
  - '## GROUP : nginx'
  - '## TAGS  : nginx,debug,logging,howto'
  - '## FILE  : howto-debug-nginx.txt'
  - '################################################################################'
  - ''
  - ''
  - '################################################################################'
  - '## description'
  - '################################################################################'
  - ''
  - '    # Instructions how to debug nginx.'
  - ''
  - '################################################################################'
  - '## references'
  - '################################################################################'
  - ''
  - '    # Versions'
  - '    # nginx version: nginx/1.13.5'
  - ''
  - '    # Official nginx debugging'
  - '    > https://www.nginx.com/resources/admin-guide/debug/'
  - ''
  - '    # Dynamic upstreams'
  - '    > https://www.nginx.com/blog/dns-service-discovery-nginx-plus/'
  - '    > https://tenzer.dk/nginx-with-dynamic-upstreams/'
  - ''
  - '################################################################################'
  - '## commands'
  - '################################################################################'
  - ''
  - '    # Test if nginx is configured with --with-debug'
  - '    $ nginx -V 2>&1 | grep -- ''--with-debug'''
  - ''
  - '    # Check the logs are forwarded to stdout/stderr and remove links'
  - '    $ ls -al /var/log/nginx/'
  - '    $ unlink /var/log/nginx/access.log'
  - '    $ unlink /var/log/nginx/error.log'
  - ''
  - '    # Reloading nginx configuration'
  - '    $ nginx -s reload'
  - ''
  - '################################################################################'
  - '## solutions'
  - '################################################################################'
  - ''
  - '################################################################################'
  - '## configurations'
  - '################################################################################'
  - ''
  - '    # Configuring nginx default.conf. The upstream blocks are resolved only'
  - '    # once when the nginx starts. The variable trick allows resolving the'
  - '    # IP address. This allows recovery from situations where for example'
  - '    # a docker container restart changes the IP address. See ''Dynamic'
  - '    # upstreams'' for more information.'
  - '    $ vi conf.d/default.conf'
  - '      upstream kibana_servers {'
  - '          server kibana:5601;'
  - '      }'
  - '      upstream elasticsearch_servers {'
  - '          server elasticsearch:9200;'
  - '      }'
  - '      #resolver 127.0.0.11 valid=1s ipv6=off; # Resolver for docker container.'
  - '      server {'
  - '          listen 9200;'
  - '          add_header X-Frame-Options "SAMEORIGIN";'
  - '          proxy_set_header        Host $host;'
  - '          proxy_set_header        X-Real-IP $remote_addr;'
  - '          proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;'
  - '          proxy_set_header        X-Forwarded-Proto $scheme;'
  - '          proxy_set_header        X-Forwarded-Host $http_host;'
  - '          location / {'
  - '                  set $kibana_servers     kibana;'
  - '                  proxy_pass              http://$kibana_test:5601;'
  - '                  #proxy_pass             http://kibana_servers;'
  - '          }'
  - '          location /kibana {'
  - '                  proxy_pass              http://kibana_servers/app/kibana;'
  - '          }'
  - '          location ~ /elastic(/|$)(.*) {'
  - '                  proxy_pass              http://elasticsearch_servers/$2;'
  - '          }'
  - '      }'
  - ''
  - '    $ vi nginx.conf'
  - '      user  nginx;'
  - '      worker_processes  1;'
  - ''
  - '      error_log  /var/log/nginx/error.log debug;'
  - '      pid        /var/run/nginx.pid;'
  - ''
  - '      events {'
  - '          worker_connections  1024;'
  - '      }'
  - ''
  - ''
  - '      http {'
  - '          include       /etc/nginx/mime.types;'
  - '          default_type  application/octet-stream;'
  - ''
  - '          log_format  main  ''$remote_addr - $remote_user [$time_local] "$request"
    '''
  - '                            ''$status $body_bytes_sent "$http_referer" '''
  - '                            ''"$http_user_agent" "$http_x_forwarded_for"'';'
  - ''
  - '          access_log  /var/log/nginx/access.log  main;'
  - ''
  - '          sendfile        on;'
  - '          #tcp_nopush     on;'
  - ''
  - '          keepalive_timeout  65;'
  - ''
  - '          #gzip  on;'
  - ''
  - '          include /etc/nginx/conf.d/*.conf;'
  - '      }'
  - ''
  - '################################################################################'
  - '## whiteboard'
  - '################################################################################'
  - ''
  - '    # Change nginx configuration'
  - '    $ docker exec -i -t $(docker ps | egrep -m 1 ''petelk/nginx'' | awk ''{print
    $1}'') /bin/bash'
  - '    $ echo '''
  - '      upstream kibana_servers {'
  - '          server kibana:5601;'
  - '      }'
  - '      upstream elasticsearch_servers {'
  - '          server elasticsearch:9200;'
  - '      }'
  - '      upstream registry_servers {'
  - '          server registry:5000;'
  - '      }'
  - '      upstream jenkins_servers {'
  - '          server jenkins:8080;'
  - '      }'
  - '      server {'
  - '          resolver kube-dns.kube-system.svc.cluster.local;'
  - '          error_log /nginx.log debug;'
  - '          access_log /access.log;'
  - '          client_max_body_size 0;'
  - '          listen 9200;'
  - '          add_header X-Frame-Options "SAMEORIGIN";'
  - '          proxy_set_header        Host $host;'
  - '          proxy_set_header        X-Real-IP $remote_addr;'
  - '          proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;'
  - '          proxy_set_header        X-Forwarded-Proto $scheme;'
  - '          proxy_set_header        X-Forwarded-Host $http_host;'
  - '          location /kibana {'
  - '              proxy_pass          http://kibana_servers/app/kibana;'
  - '          }'
  - '          location / {'
  - '              proxy_pass          http://kibana_servers;'
  - '          }'
  - '          location ~ /elastic(/|$)(.*) {'
  - '              proxy_pass          http://elasticsearch_servers/$2;'
  - '          }'
  - '          location /v2 {'
  - '              proxy_pass          http://registry:5000;'
  - '              proxy_read_timeout  900;'
  - '          }'
  - '          location /jenkins {'
  - '              proxy_pass          http://jenkins:8080;'
  - '          }'
  - '      }'
  - '      '' | tee /etc/nginx/conf.d/default.conf && nginx -s reload'
  - ''
  digest: c9c40cdf10afbe6efd20615f71cc33e03cb028676dbd0690a320373cfd520825
  filename: howto-debug-nginx.txt
  group: nginx
  links:
  - https://tenzer.dk/nginx-with-dynamic-upstreams/
  - https://www.nginx.com/blog/dns-service-discovery-nginx-plus/
  - https://www.nginx.com/resources/admin-guide/debug/
  tags:
  - debug
  - howto
  - logging
  - nginx
  utc: '2017-11-15 08:48:50'
- brief: Debugging Elastic Beats
  category: solution
  data:
  - '################################################################################'
  - '## BRIEF : Debugging Elastic Beats'
  - '##'
  - '## DATE  : 2017-10-20 11:11:19'
  - '## GROUP : beats'
  - '## TAGS  : Elastic,beats,filebeat,debug,howto'
  - '## FILE  : howto-debug-elastic-beats.txt'
  - '################################################################################'
  - ''
  - ''
  - '################################################################################'
  - '## description'
  - '################################################################################'
  - ''
  - '    # Debug and configure Elastic Beats.'
  - ''
  - '################################################################################'
  - '## references'
  - '################################################################################'
  - ''
  - '    # Filebeat configuration'
  - '    > https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-configuration-details.html'
  - ''
  - '    # Enable logs from Filebeat'
  - '    > https://www.elastic.co/guide/en/beats/filebeat/master/enable-filebeat-debugging.html'
  - ''
  - '################################################################################'
  - '## commands'
  - '################################################################################'
  - ''
  - '    # Run Filebeat with full log level'
  - '    $ ./filebeat -e -c config/filebeat.yml -d "*"'
  - ''
  - '################################################################################'
  - '## solutions'
  - '################################################################################'
  - ''
  - '################################################################################'
  - '## configurations'
  - '################################################################################'
  - ''
  - '    # Filebeat configuration'
  - '    $ vi config/filebeat.yml'
  - '      filebeat.prospectors:'
  - '      - input_type: log'
  - '        paths:'
  - '          - ./examples/cbts-syslogs.log'
  - '        fields:'
  - '          es_index: "petelk.syslog"'
  - '          es_codec: "plain"'
  - '          es_class: "syslog"'
  - ''
  - '      - input_type: log'
  - '        paths:'
  - '          - ./examples/counters.json'
  - '        fields:'
  - '          es_index: "petelk.counters"'
  - '          es_codec: "json"'
  - '          es_class: "counter"'
  - ''
  - '      #processors:'
  - '      # - decode_json_fields:'
  - '      #     fields: ["message"]'
  - '      #     process_array: false'
  - '      #     max_depth: 3'
  - '      #     when:'
  - '      #       equals:'
  - '      #         fields.es_codec: "json"'
  - ''
  - '      output.logstash:'
  - '        hosts: ["logstash:5044"]'
  - ''
  - '    # Logstash pipeline configuration.'
  - '    $ vi pipeline/filebeat.json'
  - '      input {'
  - '          beats {'
  - '              port => 5044'
  - '          }'
  - '      }'
  - ''
  - '      filter {'
  - '          if [fields][es_codec] == "json" {'
  - '              json {'
  - '                  source => "message"'
  - '              }'
  - '          }'
  - '      }'
  - ''
  - '      output {'
  - '          if [fields][es_codec] == "plain" {'
  - '              elasticsearch {'
  - '                  hosts => ["elasticsearch:9200"]'
  - '                  index => "%{[fields][es_index]}-%{+YYYY.MM.dd}"'
  - '                  document_type => "%{[fields][es_class]}"'
  - '                  user => "elastic"'
  - '                  password => "changeme"'
  - '              }'
  - '          } else {'
  - '              elasticsearch {'
  - '                  hosts => ["elasticsearch:9200"]'
  - '                  index => "%{[fields][es_index]}-%{+YYYY.MM.dd}"'
  - '                  document_type => "%{[fields][es_class]}"'
  - '                  user => "elastic"'
  - '                  password => "changeme"'
  - '              }'
  - '          }'
  - '      }'
  - ''
  - '################################################################################'
  - '## whiteboard'
  - '################################################################################'
  - ''
  digest: 76a1a02951f6bcb423103b67c1deafd79c0ae19e46dedda910c2770cc2c2e26e
  filename: howto-debug-elastic-beats.txt
  group: beats
  links:
  - https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-configuration-details.html
  - https://www.elastic.co/guide/en/beats/filebeat/master/enable-filebeat-debugging.html
  tags:
  - Elastic
  - beats
  - debug
  - filebeat
  - howto
  utc: '2017-10-30 08:21:40'
- brief: Debugging Docker
  category: solution
  data:
  - '################################################################################'
  - '## BRIEF : Debugging Docker '
  - '##'
  - '## DATE  : 2017-11-14 10:36:39'
  - '## GROUP : docker'
  - '## TAGS  : docker,debug,howto,swarm'
  - '## FILE  : howto-debug-docker.txt'
  - '################################################################################'
  - ''
  - ''
  - '################################################################################'
  - '## description'
  - '################################################################################'
  - ''
  - '    # Instructions how to debug Docker.'
  - ''
  - '################################################################################'
  - '## references'
  - '################################################################################'
  - ''
  - '    # Versions'
  - '    # Docker version 17.09.0-ce, build afdb6d4'
  - '    # docker-compose version 1.16.1, build 6d1ac21'
  - ''
  - '    # Docker CE release notes'
  - '    > https://docs.docker.com/release-notes/docker-ce/'
  - ''
  - '    # Docker-compose release notes'
  - '    > https://github.com/docker/compose/releases/'
  - ''
  - '    # Name server lookup'
  - '    > https://www.computerhope.com/unix/unslooku.htm'
  - ''
  - '    # Resolving host names from containers'
  - '    > https://github.com/docker/libnetwork/pull/1855'
  - '    > https://github.com/docker/swarmkit/issues/1242'
  - ''
  - '################################################################################'
  - '## commands'
  - '################################################################################'
  - ''
  - '    # Login to remote registry'
  - '    $ docker login -u admin -p registry 10.133.200.67:5000'
  - ''
  - '    # Creating and updating services in docker swarm'
  - '    $ docker service ls'
  - '    $ docker service rm elk_elasticsearch'
  - '    $ docker service create --network elk_default --name elk_elasticsearch --hostname={{.Service.Name}}-{{.Task.Slot}}
    elk/elasticsearch:latest'
  - '    $ docker service create --network elk_default --name elk_nginx --host elk_kibana:10.0.0.15
    --host elk_elasticsearch:10.0.0.20 elk/nginx:latest'
  - '    $ docker service update --force 2cp9rhiul9ss'
  - ''
  - '    # Inspecting swarm default overlay network'
  - '    $ docker network inspect elk_default'
  - ''
  - '    # Name server lookup'
  - '    $ nslookup -type=a elasticsearch'
  - ''
  - '################################################################################'
  - '## solutions'
  - '################################################################################'
  - ''
  - '################################################################################'
  - '## configurations'
  - '################################################################################'
  - ''
  - '################################################################################'
  - '## whiteboard'
  - '################################################################################'
  - ''
  - '    # Host names are not DNS resolvable from docker swarm internal DNS.'
  - '    > https://github.com/docker/libnetwork/pull/1855'
  - '    > https://github.com/docker/swarmkit/issues/1242'
  - ''
  digest: e2d4df9eb68749cb6eafcc488e873cdb35d128b2ad76ec90b12e6ed7062a9b4e
  filename: howto-debug-docker.txt
  group: docker
  links:
  - https://docs.docker.com/release-notes/docker-ce/
  - https://github.com/docker/compose/releases/
  - https://github.com/docker/libnetwork/pull/1855
  - https://github.com/docker/libnetwork/pull/1855
  - https://github.com/docker/swarmkit/issues/1242
  - https://github.com/docker/swarmkit/issues/1242
  - https://www.computerhope.com/unix/unslooku.htm
  tags:
  - debug
  - docker
  - howto
  - swarm
  utc: '2017-11-14 10:36:39'
