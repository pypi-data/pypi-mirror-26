{% load squad %}
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <style type='text/css'>
/**
*** SIMPLE GRID
*** (C) ZACH COLE 2016
*** http://simplegrid.io/
** local modifications:
   - drop @import of font from google (don't pull external resources)
**/

/* UNIVERSAL */

html,
body {
  height: 100%;
  width: 100%;
  margin: 0;
  padding: 0;
  left: 0;
  top: 0;
  font-size: 100%;
}

/* ROOT FONT STYLES */

* {
  font-family: 'Lato', Helvetica, sans-serif;
  color: #333447;
  line-height: 1.5;
}

/* TYPOGRAPHY */

h1 {
  font-size: 2.5rem;
}

h2 {
  font-size: 2rem;
}

h3 {
  font-size: 1.375rem;
}

h4 {
  font-size: 1.125rem;
}

h5 {
  font-size: 1rem;
}

h6 {
  font-size: 0.875rem;
}

p {
  font-size: 1.125rem;
  font-weight: 200;
  line-height: 1.8;
}

.font-light {
  font-weight: 300;
}

.font-regular {
  font-weight: 400;
}

.font-heavy {
  font-weight: 700;
}

/* POSITIONING */

.left {
  text-align: left;
}

.right {
  text-align: right;
}

.center {
  text-align: center;
  margin-left: auto;
  margin-right: auto;
}

.justify {
  text-align: justify;
}

/* ==== GRID SYSTEM ==== */

.container {
  width: 90%;
  margin-left: auto;
  margin-right: auto;
}

.row {
  position: relative;
  width: 100%;
}

.row [class^="col"] {
  float: left;
  margin: 0.5rem 2%;
  min-height: 0.125rem;
}

.col-1,
.col-2,
.col-3,
.col-4,
.col-5,
.col-6,
.col-7,
.col-8,
.col-9,
.col-10,
.col-11,
.col-12 {
  width: 96%;
}

.col-1-sm {
  width: 4.33%;
}

.col-2-sm {
  width: 12.66%;
}

.col-3-sm {
  width: 21%;
}

.col-4-sm {
  width: 29.33%;
}

.col-5-sm {
  width: 37.66%;
}

.col-6-sm {
  width: 46%;
}

.col-7-sm {
  width: 54.33%;
}

.col-8-sm {
  width: 62.66%;
}

.col-9-sm {
  width: 71%;
}

.col-10-sm {
  width: 79.33%;
}

.col-11-sm {
  width: 87.66%;
}

.col-12-sm {
  width: 96%;
}

.row::after {
	content: "";
	display: table;
	clear: both;
}

.hidden-sm {
  display: none;
}

@media only screen and (min-width: 33.75em) {  /* 540px */
  .container {
    width: 80%;
  }
}

@media only screen and (min-width: 45em) {  /* 720px */
  .col-1 {
    width: 4.33%;
  }

  .col-2 {
    width: 12.66%;
  }

  .col-3 {
    width: 21%;
  }

  .col-4 {
    width: 29.33%;
  }

  .col-5 {
    width: 37.66%;
  }

  .col-6 {
    width: 46%;
  }

  .col-7 {
    width: 54.33%;
  }

  .col-8 {
    width: 62.66%;
  }

  .col-9 {
    width: 71%;
  }

  .col-10 {
    width: 79.33%;
  }

  .col-11 {
    width: 87.66%;
  }

  .col-12 {
    width: 96%;
  }

  .hidden-sm {
    display: block;
  }
}

@media only screen and (min-width: 60em) { /* 960px */
  .container {
    width: 75%;
    max-width: 60rem;
  }
}

/****************** CUSTOM STYLES *****************/
.row {
  border-top: 1px solid #babdb6;
}
.key {
  font-weight: bold;
}
table {
  border-collapse: collapse;
}
th, td {
  border: 1px solid #babdb6;
}
td.pass {
  background: #b9e38f;
}
td.fail {
  background: #f08989;
}
.footer {
  margin-top: 2em;
}
    </style>
  </head>
  <body>
    <div class='container'>
    <h1>Summary</h1>
    <div class='row'><div class='col-3 key'>Tests:   </div>  <div class='col-9'>{{summary.tests_total}} </div></div>
    <div class='row'><div class='col-3 key'>Failed:  </div>  <div class='col-9'>{{summary.tests_fail}}  </div></div>
    <div class='row'><div class='col-3 key'>Passed:  </div>  <div class='col-9'>{{summary.tests_pass}}  </div></div>
    <div class='row'><div class='col-3 key'>Skipped: </div>  <div class='col-9'>{{summary.tests_skip}}  </div></div>
    <div class='row'><div class='col-3 key'>Build:   </div>  <div class='col-9'>{{build.version}}       </div></div>
    <div class='row'><div class='col-12 key'> <a href="{{settings.BASE_URL}}/{{build.project}}/build/{{build.version}}">See details</a> </div></div>
    {% if important_metadata %}
    {% for key, value in important_metadata.items %}
      <div class='row'>
        <div class='col-3 key'>{{key}}</div>
        <div class='col-9'>{{value|metadata_value|urlize}}</div>
      </div>
      {% endfor %}
    {% endif %}


    <h1>Regressions{%if previous_build %} (compared to build {{previous_build.version}}){% endif %}</h1>
    {% if regressions %}
    <ul>
      {% for env, tests in regressions.items %}
      <li><strong>{{env}}:</strong>
        <ul>
          {% for test in tests %}
          <li>{{test}}</li>
          {% endfor %}
        </ul>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <em>(none)</em>
    {% endif %}


    <h1>Failures</h1>
    {% if summary.failures %}
    <ul>
      {% for env, tests in summary.failures.items %}
      <li>
        <strong>{{env}}:</strong>
        <ul>
          {% for test in tests %}
          <li>
            <a href="{{settings.BASE_URL}}/{{build.project}}/build/{{build.version}}/testrun/{{test.test_run.job_id}}">{{test.full_name}}</a>
            {% if test.test_run.log_file %}
            <a href="{{settings.BASE_URL}}/{{build.project}}/build/{{build.version}}/testrun/{{test.test_run.job_id}}/log">(log)</a>
            {% endif %}
            {% if test.history.since %}
              &mdash;
              {% if test.history.last_different %}
                {% with build=test.history.since.test_run.build %}
                failing since build {{build.version}}, from {{build.datetime}}
                {% endwith %}
              {% else %}
                never passed
              {% endif %}
            {% endif %}
          </li>
          {% endfor %}
        </ul>
      </li>
      {% endfor %}
    </ul>
    {% else %}
    <em>(none)</em>
    {% endif %}


    <h1>All changes detected{%if previous_build %} (compared to build {{previous_build.version}}){% endif %}</h1>
    {% with comparison=notification.comparison %}
    <table>
      <tr>
        <td rowspan='2'></td>
        {% for environment in comparison.all_environments %}
        <th colspan='{{comparison.builds|length}}'>
          {{environment}}
        </th>
        {% endfor %}
      </tr>
      <tr>
        {% for environment in comparison.all_environments %}
        {% for build in comparison.builds %}
        <th>
          {{build.version}}
        </th>
        {% endfor %}
        {% endfor %}
      </tr>
      {% for test, results in comparison.diff.items %}
      <tr>
        <th>{{test}}</th>
        {% for environment in comparison.all_environments %}
        {% for build in comparison.builds %}
        {% with result=results|test_result_by_build:build|test_result_by_env:environment %}
        <td class='{{result}}'>
          {% if result %}
          <strong>{{result}}</strong>
          {% else %}
          <i>n/a</i>
          {% endif %}
        </td>
        {% endwith %}
        {% endfor %}
        {% endfor %}
      </tr>
      {% endfor %}
    </table>
    {% endwith %}

    <div class='footer'>
    Sent by <a href="{{settings.BASE_URL}}">{{settings.SITE_NAME}}</a>
    </div>
    </div>
  </body>
</html>
